# nginx.conf — минимально-жёсткая и рабочая конфигурация для Docker + Django
# Замените yourdomain.com на ваш реальный домен и смонтируйте сертификаты в контейнер.

user  nginx;
worker_processes  auto;
worker_rlimit_nofile 65536;

error_log  /dev/stderr warn;
pid        /tmp/nginx.pid;

events {
    worker_connections 1024;
    # use epoll — работает на Linux, nginx сам обычно выбирает оптимальный механизм,
    # но явно указывать не вредно:
    use epoll;
    accept_mutex on;
    # multi_accept off — более предсказуемое поведение под контейнерами
    multi_accept off;
}

http {
    ## базовые оптимизации
    sendfile           on;
    tcp_nopush         on;
    tcp_nodelay        on;
    keepalive_timeout  65;
    types_hash_max_size 2048;
    include            /etc/nginx/mime.types;
    default_type       application/octet-stream;

    ## лимиты/таймауты (подходящие для большинства приложений)
    client_max_body_size        10m;
    client_body_buffer_size     128k;
    client_header_buffer_size   1k;
    large_client_header_buffers 4 4k;

    client_body_timeout   10s;
    client_header_timeout 10s;
    reset_timedout_connection on;
    # send_timeout немного увеличен — 2s слишком агрессивно
    send_timeout 10s;

    ## Защита от простых DDoS/рейтов
    # размер зоны — 1m (~16k записей) — достаточно экономно по памяти
    limit_req_zone $binary_remote_addr zone=ddos:1m rate=30r/m;
    limit_conn_zone $binary_remote_addr zone=conn_limit_per_ip:1m;

    ## Логирование в stdout/stderr — важно для Docker
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';
    access_log /dev/stdout main;

    ## SSL / TLS
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:'
                'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:'
                'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256';
    ssl_ecdh_curve secp384r1;
    ssl_session_timeout 10m;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;

    # для OCSP stapling требуется доверенный сертификат цепочки
    ssl_trusted_certificate /etc/letsencrypt/live/yourdomain.com/chain.pem;
    ssl_stapling on;
    ssl_stapling_verify on;

    ssl_dhparam /etc/nginx/ssl/dhparam.pem;

    resolver 8.8.8.8 8.8.4.4 valid=300s;
    resolver_timeout 5s;

    ## HSTS header через map (включается только при https)
    map $scheme $sts_header {
        default "";
        https "max-age=63072000; includeSubDomains; preload";
    }

    ## upstream — куда проксировать Django (docker-compose service: web:8000)
    upstream django_app_server {
        server web:8000;
        keepalive 16;
    }

    #################################
    # HTTP -> HTTPS: редиректный сервер (слушает порт 80)
    #################################
    server {
        listen 80 default_server;
        listen [::]:80 default_server;
        server_name solichny.intellectum.ru www.solichny.intellectum.ru;

        # Если пришёл запрос на неизвестный host — сразу рубим
        if ($host !~* ^(solichny.intellectum.ru|www.solichny.intellectum.ru)$) {
            return 444;
        }

        # редирект на https (сохраняем URI)
        return 301 https://$host$request_uri;
    }

    #################################
    # HTTPS server — основной
    #################################
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name yourdomain.com www.yourdomain.com;

        # SSL certs (смонтируйте в контейнер)
        ssl_certificate     /etc/letsencrypt/live/yourdomain.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/yourdomain.com/privkey.pem;

        # базовая защита от Host header атак
        if ($host !~* ^(yourdomain.com|www.yourdomain.com)$) {
            return 444;
        }

        # корень для статических fallback-страниц (может не использоваться)
        root /var/www/html;
        index index.html;

        ## заголовки безопасности
        add_header Strict-Transport-Security $sts_header always;
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
        add_header Referrer-Policy "strict-origin-when-cross-origin" always;
        add_header Permissions-Policy "geolocation=(),midi=(),sync-xhr=(),microphone=(),camera=(),magnetometer=(),gyroscope=(),fullscreen=(self),payment=()" always;

        # Content-Security-Policy — адаптируйте под ваше приложение.
        # Убрал здесь жёсткие unsafe-* рекомендации; при наличии inline-скриптов
        # вам придётся добавить nonce/hash или временно вернуть 'unsafe-inline'.
        add_header Content-Security-Policy "default-src 'self'; script-src 'self' https://cdn.yourdomain.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; img-src 'self' data: https:; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; frame-src 'none'; object-src 'none'; media-src 'self'; form-action 'self'; base-uri 'self';" always;

        #################################
        # Статика (отдаётся nginx напрямую)
        #################################
        location /staticfiles/ {
            alias /app/staticfiles/;
            expires 365d;
            access_log off;
            add_header Cache-Control "public, max-age=31536000";
            # Запрет выполнения скриптов в статике
            location ~* \.(php|pl|py|jsp|asp|sh|cgi)$ {
                deny all;
                return 404;
            }
        }

        location /media/ {
            alias /app/media/;
            expires 30d;
            access_log off;
            add_header Cache-Control "public, max-age=2592000";
            location ~* \.(php|pl|py|jsp|asp|sh|cgi)$ {
                deny all;
                return 404;
            }
        }

        #################################
        # Проксирование в Django
        #################################
        location / {
            # rate limiting per IP
            limit_req zone=ddos burst=50 nodelay;
            limit_conn conn_limit_per_ip 20;

            proxy_pass http://django_app_server;
            proxy_http_version 1.1;

            # WebSocket / Upgrade support
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $http_connection;

            # стандартные заголовки
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # прокси-параметры для устойчивости
            proxy_redirect off;
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 24k;
            proxy_temp_file_write_size 32k;
            proxy_max_temp_file_size 0;
            proxy_read_timeout 300s;

            # выставляем куки безопасно
            proxy_cookie_path / "/; HTTPOnly; Secure; SameSite=Lax";

            # скрываем служебные заголовки
            proxy_hide_header X-Powered-By;
            proxy_hide_header Server;
        }

        #################################
        # Доп. защита админки (пример)
        #################################
        location /qfww14934infwqfn3ij19930i2jm0d1ifnf/ {
            # Настройте под свои IP
            allow 192.168.1.137/24;
            deny all;

            # Доп. базовая аутентификация (опционально)
            auth_basic "Admin Area";
            auth_basic_user_file /etc/nginx/.htpasswd;

            proxy_pass http://django_app_server;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /sdfvjnwovneonvewjnvwdnvjdffvjq32r2r12f/ {
            # Настройте под свои IP
            allow 192.168.1.137/24;
            deny all;

            # Доп. базовая аутентификация (опционально)
            auth_basic "Admin Area";
            auth_basic_user_file /etc/nginx/.htpasswd;

            proxy_pass http://django_app_server;
            proxy_http_version 1.1;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          
}
        # запрет доступа к скрытым файлам (кроме .well-known)
        location ~ /\.(?!well-known) {
            deny all;
            access_log off;
            log_not_found off;
            return 404;
        }

        # блок распространённых эксплоитов
        location ~* ^/(autodiscover|\.git|\.env|wp-login|xmlrpc) {
            deny all;
            return 444;
        }

        location = /50x.html {
            root /usr/share/nginx/html;
            internal;
        }
    } # конец server 443
} # конец http

