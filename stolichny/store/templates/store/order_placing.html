{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'store/css/order_placing.css' %}">
{% endblock %}

<head><meta name="viewport" content="width=device-width, initial-scale=1.0"></head>

<div class="checkout-container">

  <div class="checkout-card">
    <a href='/cart/' class='back-btn'>← К корзине<a>

    <form method="POST" action="{% url 'order_sending' %}" id="profile-form">
      {% csrf_token %}
      

      <!-- Личные данные -->
      <div class="checkout-section">
        <h2 class="section-title">Оформление заказа</h2>

      <div class="form-group">

        <input type="checkbox" id="pickup" name="pickup" class="pickup-input">
        <label for="pickup">Заберу сам(а)</label>
        <br></br>

        <label for="delivery_area">В какой район доставляем?</label>
        <select id="delivery_area" name="delivery_area" required>
          <option value="">Выберите район</option>
          {% for area, price in delivery_zones.items %}
            <option value="{{ area }}">{{ area }} (+{{ price }} ₽)</option>
          {% endfor %}
        </select>
      <br></br>
      </div>

        <label for="address">Подробности адреса (улица, дом и т.д.)</label>
        <input type="text" id="address" name="address" placeholder="Улица, дом, квартира" required>


        <label>Телефон</label>
        <input type="text" value="+7{{ user.profile.phone_number }}" readonly class="readonly">

        <label>Email</label>
        <input type="email" value="{{ user.email }}" name="email" required='ture'>

      </div>
        <label for="comment">Коментарий к заказу</label>
        <input type="text" id="comment" name="comment">

      <!-- Список товаров -->
      <div class="checkout-section">
        <h2 class="section-title">Товары в заказе</h2>
        <ul class="product-list">
          {% for item in cart_items %} 
            <li>{{ item.product.name }} - {{ item.product.price }} ₽ — <strong>{{ item.quantity }}</strong> шт.</li>
          {% endfor %}
        </ul>
      </div>

      <!-- Способ оплаты -->
        <div class="checkout-section">
        <h2 class="section-title">Как будете оплачивать?</h2>
        <div class="payment-options">
            <label class="payment-option">
            <input type="radio" name="payment_method" value="cash" required>
            <img src="{% static 'store/images/cash.png' %}" alt="Наличные">
            <span>Наличными</span>
            </label>

            <label class="payment-option">
            <input type="radio" name="payment_method" value="card">
            <img src="{% static 'store/images/card.png' %}" alt="Карта">
            <span>Картой при получении</span>
            </label>
          </div>
          <br></br>

              <div class="form-group">
            <input type="checkbox" id="door_delivery" name="door_delivery" class="pickup-input">
            <label for="door_delivery">Доставим до двери, но +50 ₽</label>
              </div>

        <br></br>
        <div class="form-group">
          <label for="change_from_input">Сдача с:</label>

        <input type="number" id="change_from_input" min="0" step="1" placeholder="Заплачу без сдачи" value="" />
        <input type="hidden" id="change_from_hidden" name="change_from" value="" />
        </div>
        <!-- /NEW -->

        </div>

      <!-- Предупреждение -->
      <div class="warning-box">
        <strong>Внимание!</strong> После того как курьер отправится с заказом, отмена станет невозможна. 
        При повторяющихся неоплаченных заказах <b>Ваша учетная запись может быть временно ограничена.</b>
      </div>
      
      <!-- Сумма заказа -->
        <div class="total-box">
          <p>Доставка: - ₽ </p>

          <span class="total-label">Итого к оплате:</span>

          <br></br>

          {% if discount_price %}
            <div class="price-wrapper">
              <div class="discounted">
                <span class="old-price">{{ total }} ₽</span>
                <span class="new-price">{{ discount_price }} ₽</span>
                <span class="discount-badge">−{{ discount_percent }}%</span>
              </div>
            </div>
          {% else %}
            <span class="total-price">{{ total }} ₽</span>
          {% endif %}
        </div>


      <!-- Кнопка -->
        <div class="submit-wrapper">
             <button type="submit" class="btn-submit" id="submit-btn">Подтвердить заказ</button>
        </div>
    </form>
  </div>
</div>

<!-- NEW: Скрипт управления полем "Сдача с" -->
<script>
(function() {
  const pickupCheckbox = document.getElementById('pickup');
  const paymentRadios = document.getElementsByName('payment_method');
  const changeInput = document.getElementById('change_from_input');
  const changeHidden = document.getElementById('change_from_hidden');

  if (!changeInput || !changeHidden) return;

  // Устанавливает состояние поля: включено только при оплате наличными и если не выбран "заберу сам"
  function updateChangeField() {
    const isPickup = pickupCheckbox && pickupCheckbox.checked;
    let selectedPayment = null;
    for (const r of paymentRadios) {
      if (r.checked) { selectedPayment = r.value; break; }
    }

    const shouldEnable = (selectedPayment === 'cash') && !isPickup;

    if (shouldEnable) {
      // включаем поле для ввода
      changeInput.removeAttribute('disabled');
      // если ранее было пусто — поставим нейтральный плейсхолдер
      if (!changeInput.value) {
        changeInput.placeholder = 'Заплачу без сдачи';
      }
      // синхронизируем скрытое поле (может быть пустым)
      changeHidden.value = changeInput.value || '';
    } else {
      // отключаем и сбрасываем значение — делаем пустым и ставим плейсхолдер "Заплачу без сдачи"
      changeInput.value = '';
      changeInput.setAttribute('disabled', 'disabled');
      changeInput.placeholder = 'Заплачу без сдачи';
      // скрытое поле содержит пустую строку — сервер получит пустое значение
      changeHidden.value = '';
    }
  }

  // копируем значение в скрытое поле при вводе
  changeInput.addEventListener('input', function() {
    // если пользователь ввёл число — сохраняем; если поле пустое — отправим пустую строку
    changeHidden.value = changeInput.value !== null ? changeInput.value : '';
  });

  // слушаем изменение оплаты
  for (const r of paymentRadios) {
    r.addEventListener('change', updateChangeField);
  }

  // слушаем чекбокс "заберу сам"
  if (pickupCheckbox) {
    pickupCheckbox.addEventListener('change', updateChangeField);
  }

  // Инициализация состояния (вызов в конце — на случай, если скрипт загружен после DOMContentLoaded)
  document.addEventListener('DOMContentLoaded', updateChangeField);
  updateChangeField();
})();

const changeInput = document.getElementById('change_from_input');
const changeHidden = document.getElementById('change_from_hidden');

changeInput.addEventListener('input', () => {
  // Оставляем только цифры, максимум 5 символов
  let v = String(changeInput.value).replace(/\D/g, '').slice(0, 5);
  changeInput.value = v;
  changeHidden.value = v;
});

</script>
<!-- /NEW -->

<script src="{% static 'store/js/order_placing1.js' %}"></script>
